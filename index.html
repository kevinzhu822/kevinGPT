<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KevinGPT Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
  <div class="max-w-2xl mx-auto mt-10 p-6" x-data="{
    showLogin: true,
    init() {
      console.log('Alpine init called');
      const token = localStorage.getItem('id_token');
      this.showLogin = !token;
      console.log('Token present:', token ? 'Yes' : 'No');
    }
  }">
    <h1 class="text-3xl font-bold text-center mb-8">KevinGPT Admin Panel</h1>

    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">App Status</h2>
        <button onclick="getStatus()" class="text-blue-600 hover:underline text-sm">Refresh</button>
      </div>
      <div id="appStatus" class="font-medium">Loading...</div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">EC2 Instance State</h2>
        <button onclick="getEC2State()" class="text-blue-600 hover:underline text-sm">Refresh</button>
      </div>
      <div id="ec2State" class="font-medium">Loading...</div>
      <div id="stateTimer" class="text-sm mt-2 text-gray-600"></div>
      <div id="lastChecked" class="text-xs text-gray-500 mt-1"></div>
      <div id="progressWrapper" class="w-full bg-gray-200 rounded-full h-3 mt-3 hidden">
        <div id="progressBar" class="bg-yellow-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">EC2 Controls</h2>
        <span class="text-sm" :class="showLogin ? 'text-gray-400' : 'text-green-600'" x-text="showLogin ? '(Login Required)' : 'Logged In âœ“'"></span>
      </div>

      <div id="authPanel" x-show="!showLogin" class="space-x-2 mb-3">
        <button onclick="startEC2()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Start</button>
        <button onclick="stopEC2()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Stop</button>
      </div>

      <template x-if="showLogin">
        <button onclick="login()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Log In with Cognito</button>
      </template>
    </div>
  </div>

  <script>
    const COGNITO_DOMAIN = "login.kevin-zhu.com";
    const CLIENT_ID = "1epb6123uv6n1mq9q5t8sias9u";
    const REDIRECT_URI = "https://admin.kevin-zhu.com";

    const API_HEALTH_URL = "https://chat.kevin-zhu.com/health";
    const API_EC2_STATE = "https://miw5dbkttmuhs4wzs5hvbkoygq0jozll.lambda-url.us-east-2.on.aws/ec2?op=status";
    const API_START_EC2 = "https://miw5dbkttmuhs4wzs5hvbkoygq0jozll.lambda-url.us-east-2.on.aws/ec2?op=start";
    const API_STOP_EC2  = "https://miw5dbkttmuhs4wzs5hvbkoygq0jozll.lambda-url.us-east-2.on.aws/ec2?op=stop";

    // Handle login token from redirect
    const urlToken = new URLSearchParams(window.location.hash.substr(1)).get("id_token");
    console.log("URL token:", urlToken);
    if (urlToken) {
      localStorage.setItem("id_token", urlToken);
      console.log("Token stored in localStorage");
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    const idToken = localStorage.getItem("id_token");
    console.log("Loaded token from localStorage:", idToken);

    function login() {
      const url = `https://${COGNITO_DOMAIN}/login?client_id=${CLIENT_ID}&response_type=token&scope=email+openid&redirect_uri=${REDIRECT_URI}`;
      console.log("Redirecting to Cognito login:", url);
      window.location.href = url;
    }

    async function getStatus() {
      try {
        console.log("Fetching health status...");
        const res = await fetch(API_HEALTH_URL);
        const data = await res.json();
        console.log("Health status:", data);
        let statusText = data.status === true || data.status === "true" ? "App is running" : "App is unavailable";
        document.getElementById("appStatus").textContent = statusText;
      } catch (err) {
        console.error("Error fetching health:", err);
        document.getElementById("appStatus").textContent = "Unable to check health.";
      }
    }

    async function getEC2State() {
      try {
        console.log("Fetching EC2 state...");
        const res = await fetch(API_EC2_STATE, {
          headers: { Authorization: idToken }
        });
        const json = await res.json();
        console.log("EC2 state response:", json);
        document.getElementById("ec2State").textContent = json.state || "Unknown";

        if (json.lastChanged) {
          const lastTime = new Date(json.lastChanged).getTime();
          function updateTimer() {
            const now = Date.now();
            const seconds = Math.floor((now - lastTime) / 1000);
            const mins = Math.floor(seconds / 60), hrs = Math.floor(mins / 60);
            const duration = hrs ? `${hrs}h ${mins % 60}m` : mins ? `${mins}m ${seconds % 60}s` : `${seconds}s`;
            let display = `Active for ${duration}`;
            if (json.lastChangedReason && json.lastChangedReason !== "none") {
              display += ` (Reason: ${json.lastChangedReason})`;
            }
            document.getElementById("stateTimer").textContent = display;
          }
          updateTimer();
          setInterval(updateTimer, 1000);
        }

        const now = new Date();
        document.getElementById("lastChecked").textContent = `Last checked: ${now.toLocaleTimeString()}`;

      } catch (err) {
        console.error("Error fetching EC2 state:", err);
        document.getElementById("ec2State").textContent = "Server Unavailable";
      }
    }

    async function startEC2() {
      try {
        console.log("Sending EC2 start request...");
        await fetch(API_START_EC2, {
          method: "POST",
          headers: { Authorization: idToken }
        });
        alert("Start request sent.");
        getEC2State();
        simulateStartupTimer();
      } catch (err) {
        console.error("Failed to start EC2:", err);
        alert("Failed to start EC2 server.");
      }
    }

    async function stopEC2() {
      try {
        console.log("Sending EC2 stop request...");
        await fetch(API_STOP_EC2, {
          method: "POST",
          headers: { Authorization: idToken }
        });
        alert("Stop request sent.");
        getEC2State();
      } catch (err) {
        console.error("Failed to stop EC2:", err);
        alert("Failed to stop EC2 server.");
      }
    }

    function simulateStartupTimer() {
      const wrapper = document.getElementById("progressWrapper");
      const bar = document.getElementById("progressBar");
      let seconds = 0;

      wrapper.classList.remove("hidden");
      bar.style.width = "0%";
      bar.style.background = "#fbbf24";

      const interval = setInterval(async () => {
        seconds++;
        const percent = Math.min((seconds / 60) * 100, 100);
        bar.style.width = percent + "%";

        try {
          const res = await fetch(API_HEALTH_URL);
          const data = await res.json();
          if (data.status && data.status.toLowerCase() === "healthy") {
            bar.style.width = "100%";
            bar.style.background = "#16a34a";
            clearInterval(interval);
          }
        } catch (err) {
          console.error("Health check error during startup simulation:", err);
        }

        if (seconds >= 60) clearInterval(interval);
      }, 1000);
    }

    getStatus();
    getEC2State();
  </script>
</body>
</html>
