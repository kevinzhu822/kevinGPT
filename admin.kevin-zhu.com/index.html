<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon-dark.ico" type="image/x-icon">
  <title>KevinGPT Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

<div class="max-w-4xl mx-auto mt-10 p-6" x-data="appData()" x-init="init()">
  <h1 class="text-3xl font-bold text-center mb-8">KevinGPT Admin Panel</h1>

  <!-- Panels -->
  <template x-for="panel in panels" :key="panel.title">
    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold" x-text="panel.title"></h2>
        <button x-show="panel.actionName" @click="$data[panel.actionName]()" class="text-blue-600 hover:underline text-sm">Refresh</button>
      </div>
      <div :id="panel.id" class="font-medium">Loading...</div>
      <div x-show="panel.subId" :id="panel.subId" class="text-xs text-gray-500 mt-1"></div>
    </div>
  </template>

  <!-- EC2 Controls -->
  <div class="bg-white p-6 rounded-xl shadow-md mb-6">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-xl font-semibold">EC2 Controls</h2>
      <span class="text-sm font-medium" :class="isLoggedIn ? 'text-green-600' : 'text-red-600'" x-text="isLoggedIn ? 'Logged In ✓' : 'Login Required'"></span>
    </div>
    <template x-if="isLoggedIn">
      <div class="space-x-2 mb-3">
        <button @click="startEC2()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Start</button>
        <button @click="stopEC2()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Stop</button>
        <button @click="fetchLogs()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Fetch Logs</button>
      </div>
    </template>
    <template x-if="!isLoggedIn">
      <button @click="login()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Log In with Cognito</button>
    </template>
  </div>

  <!-- Cost Breakdown -->
  <div class="bg-white p-6 rounded-xl shadow-md mb-6">
    <div class="flex justify-between items-center mb-2">
      <h2 id="costBreakdownHeader" class="text-xl font-semibold">Cost Breakdown</h2>
    </div>
    <template x-if="isLoggedIn">
      <div id="costBreakdown" class="space-y-6">
        <template x-for="vendor in vendors" :key="vendor.name">
          <div class="grid grid-cols-2 gap-4 items-start w-full" :id="vendor.wrapperId">
            <span class="font-medium" x-text="vendor.displayName"></span>
            <div class="flex items-center space-x-2 text-gray-600 w-full animate-pulse" :id="vendor.domId">
              <svg class="h-4 w-4 text-gray-500 animate-spin-slow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg>
              <span>Loading...</span>
            </div>
          </div>
        </template>    
      </div>
    </template>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 hidden">
  <div id="toastBox" class="relative bg-white w-96 p-6 rounded-lg shadow-2xl text-center transform scale-90 opacity-0 transition-all duration-500">
    <button id="closeToast" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none">&times;</button>
    <div id="toastIcon" class="text-4xl mb-2"></div>
    <h2 id="toastMessage" class="text-lg font-medium text-gray-800"></h2>
  </div>
</div>

<!-- Log Viewer Modal -->
<div id="logViewer" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-3xl p-6 overflow-y-auto max-h-[80vh] relative">
    <button id="closeLogViewer" class="absolute top-3 right-4 text-2xl text-gray-400 hover:text-gray-700">&times;</button>
    <h2 class="text-xl font-bold mb-4">EC2 Logs</h2>
    <pre id="logContent" class="bg-gray-100 p-4 rounded-lg text-sm text-gray-800 whitespace-pre-wrap font-mono"></pre>
  </div>
</div>

<script>
// Smooth spinner custom animation
document.head.insertAdjacentHTML('beforeend', `<style>
@keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.animate-spin-slow { animation: spin-slow 1.5s linear infinite; }
</style>`);

function appData() {
  return {
    isLoggedIn: !!localStorage.getItem('id_token'),
    vendors: [
      { name: 'openai', displayName: 'OpenAI', api: 'openai-cost', domId: 'openaiCostBreakdown' },
      { name: 'aws', displayName: 'AWS', api: 'aws-cost', domId: 'awsCostBreakdown' },
      // { name: 'brave', displayName: 'Brave (Internet Search)', api: 'brave-cost', domId: 'braveCostBreakdown' }, # FREE
    ],
    panels: [
      { title: 'App Status', id: 'appStatus', subId: 'appLastChecked', actionName: 'refreshAppStatus' },
      { title: 'EC2 State', id: 'ec2State', subId: 'lastChecked', actionName: 'refreshEC2State' },
    ],
    async init() {
      this.refreshAppStatus();
      this.refreshEC2State();
      if (this.isLoggedIn) {
        requestAnimationFrame(async () => {
          await this.fetchCosts();
        });
      }
    },
    async fetchCosts() {
      await Promise.all(this.vendors.map(async (vendor) => {
        const data = await fetchVendorData(vendor.api);
        if (!data) return;
        if (vendor.name === 'aws') {
          const rangeText = formatAwsDateRange(data);
          document.getElementById('costBreakdownHeader').textContent = `Cost Breakdown ${rangeText}`;
        }
        renderVendorCost(data, vendor.domId, vendor.name);
      }));
    },
    refreshAppStatus() {
      getStatus();
    },
    refreshEC2State() {
      getEC2State();
    },
    login,
    startEC2,
    stopEC2,
    fetchLogs,
  }
}

const API_BASE_URL = "https://miw5dbkttmuhs4wzs5hvbkoygq0jozll.lambda-url.us-east-2.on.aws";
const idToken = localStorage.getItem('id_token');

function login() {
  const domain = "login.kevin-zhu.com";
  const clientId = "1epb6123uv6n1mq9q5t8sias9u";
  const redirectUri = window.location.hostname.includes("s3-website")
    ? `http://${window.location.hostname}`
    : "https://admin.kevin-zhu.com";
  window.location.href = `https://${domain}/login?client_id=${clientId}&response_type=token&scope=email+openid&redirect_uri=${redirectUri}`;
}

async function fetchVendorData(api) {
  try {
    const res = await fetch(`${API_BASE_URL}?op=${api}`, { headers: { Authorization: idToken } });
    if (!res.ok) throw new Error('Fetch error');
    return res.json();
  } catch (err) {
    console.error(`Failed fetching ${api}:`, err);
    return null;
  }
}

function renderVendorCost(data, domId, vendorName) {
  const div = document.getElementById(domId);
  if (!div) {
    console.error(`DOM element ${domId} not found!`);
    return null;
  }
  const parent = div.parentElement;

  const contentDiv = document.createElement('div');
  contentDiv.className = "flex flex-col w-full";

  let startDate = null;
  let endDate = null;

  if (vendorName === 'aws' || vendorName === 'openai') {
    const total = vendorName === 'aws'
      ? data.services.reduce((sum, s) => sum + parseFloat(s.cost || 0), 0)
      : data.totalOpenAICost;

    const totalDiv = createTotalDiv(total);
    contentDiv.appendChild(totalDiv);

    const items = vendorName === 'aws'
      ? data.services.map(s => ({ name: s.service, cost: parseFloat(s.cost) }))
      : Object.entries(data.lineItems).map(([name, cost]) => ({ name, cost: parseFloat(cost) }));

    items.filter(i => i.cost >= 0.01)
         .sort((a, b) => b.cost - a.cost)
         .forEach(item => contentDiv.appendChild(createCostItem(item.name, item.cost)));

  } else {
    contentDiv.innerHTML = 'Vendor cost not implemented.';
  }
  parent.replaceChild(contentDiv, div);
}

function createTotalDiv(total) {
  const div = document.createElement('div');
  div.className = "grid grid-cols-2 gap-4 font-semibold border-b-2 border-gray-300 pb-2 mb-2 text-base w-full";
  div.innerHTML = `
    <span class="break-words">Total</span>
    <span class="text-right">$${truncateToCents(total).toFixed(2)}</span>
  `;
  return div;
}

function createCostItem(name, cost) {
  const div = document.createElement('div');
  div.className = "grid grid-cols-2 gap-4 text-sm border-b border-gray-200 py-2 w-full";
  div.innerHTML = `
    <span class="break-words">${name}</span>
    <span class="text-right">$${truncateToCents(cost).toFixed(2)}</span>
  `;
  return div;
}

function truncateToCents(num) {
  return Math.floor(num * 100) / 100;
}

function formatAwsDateRange(awsData) {
  if (!awsData || !awsData.start || !awsData.end) {
    return ''; // No dates to show
  }

  const startDate = new Date(awsData.start).toLocaleDateString('en-US');
  const endDate = new Date(awsData.end).toLocaleDateString('en-US');
  return `(${startDate} - ${endDate})`;
}


async function getStatus() {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 1500); // 1.5s timeout

    const res = await fetch("https://openwebui.kevin-zhu.com/health", { signal: controller.signal });
    clearTimeout(timeoutId);

    const appStatus = document.getElementById("appStatus");
    const appLastChecked = document.getElementById("appLastChecked");

    if (appStatus && appLastChecked) {
      appStatus.innerHTML = res.ok
        ? 'KevinGPT is <span class="text-green-600">online ✅</span>'
        : 'KevinGPT is <span class="text-red-600">offline ❌</span>';
      appLastChecked.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
    }
  } catch (err) {
    console.error('Health check failed', err);
    const appStatus = document.getElementById("appStatus");
    const appLastChecked = document.getElementById("appLastChecked");
    if (appStatus && appLastChecked) {
      appStatus.innerHTML = 'KevinGPT is <span class="text-red-600">offline ❌</span>';
      appLastChecked.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
    }
  }
}

async function getEC2State() {
  try {
    const res = await fetch(`${API_BASE_URL}?op=status`, { headers: { Authorization: idToken } });
    const data = await res.json();
    const state = data.state?.toLowerCase() || 'unknown';
    const ec2State = document.getElementById("ec2State");
    const lastChecked = document.getElementById("lastChecked");

    if (state === "running") {
      ec2State.innerHTML = 'EC2 is <span class="text-green-600">running 🏃‍➡️</span>';
    } else if (state === "stopped") {
      ec2State.innerHTML = 'EC2 is <span class="text-red-600">stopped ✋</span>';
    } else {
      ec2State.innerHTML = `EC2 is ${state}`;
    }

    lastChecked.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
  } catch (err) {
    console.error('EC2 status check failed', err);
  }
}

async function startEC2() {
  await ec2Action('start', 'Starting EC2...');
}
async function stopEC2() {
  await ec2Action('stop', 'Stopping EC2...');
}
async function fetchLogs() {
  try {
    const res = await fetch(`${API_BASE_URL}?op=logs`, { method: "GET", headers: { Authorization: idToken } });
    const data = await res.json();

    if (!res.ok || !data.output) {
      showToast('Failed to fetch logs. EC2 might be off.', 'error');
      return;
    }

    // Show logs nicely inside the modal
    const logViewer = document.getElementById("logViewer");
    const logContent = document.getElementById("logContent");
    logContent.textContent = data.output || 'No logs available.';
    logViewer.classList.remove("hidden");
    
  } catch (err) {
    console.error("Error fetching logs:", err);
    showToast('Network error fetching logs.', 'error');
  }
}

async function ec2Action(action, toastMessage, method = 'POST') {
  try {
    const res = await fetch(`${API_BASE_URL}?op=${action}`, { method, headers: { Authorization: idToken } });
    const rawText = await res.text();
    
    if (!res.ok) {
      console.error(`Server Error Response:`, rawText);

      let friendlyMessage = 'Action failed!';
      if (rawText.includes('already running')) {
        friendlyMessage = 'The EC2 is already running 🏃‍♂️';
      } else if (rawText.includes('already stopped')) {
        friendlyMessage = 'The EC2 is already stopped ✋';
      } else if (rawText.includes('Unauthorized')) {
        friendlyMessage = 'You are not authorized. Please log in again.';
      } else if (rawText.includes('timeout')) {
        friendlyMessage = 'The EC2 is taking too long to respond. Please try again later.';
      } else if (action === 'logs') {
        friendlyMessage = 'Cannot fetch logs. EC2 might be off.';
      }

      showToast(friendlyMessage, 'error');
      return;
    }

    // ✅ Now success handling
    if (action === 'start') {
      showToast('Successfully started EC2! 🏃‍➡️', 'success');
    } else if (action === 'stop') {
      showToast('Successfully stopped EC2! ✋', 'success');
    } else if (action === 'logs') {
      showToast('Logs fetched successfully 📜', 'success');
    } else {
      showToast(`${toastMessage} ✅`, 'success');
    }

  } catch (err) {
    console.error(`Error performing EC2 ${action}:`, err);
    showToast('Network error. Please try again.', 'error');
  }
}

// Toast logic
function showToast(message, type = 'success') {
  const toast = document.getElementById("toast");
  const toastBox = document.getElementById("toastBox");
  const toastMessage = document.getElementById("toastMessage");
  const toastIcon = document.getElementById("toastIcon");

  toastMessage.innerHTML = message.replace(/\n/g, "<br>");
  toastIcon.textContent = type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️';

  toast.classList.remove("hidden");
  requestAnimationFrame(() => {
    toastBox.classList.remove("opacity-0", "scale-90");
    toastBox.classList.add("opacity-100", "scale-100");
  });

  clearTimeout(toastBox.autoHide);
  toastBox.autoHide = setTimeout(hideToastSlow, 3000);
}

function hideToastSlow() {
  const toast = document.getElementById("toast");
  const toastBox = document.getElementById("toastBox");

  toastBox.classList.remove("opacity-100", "scale-100");
  toastBox.classList.add("opacity-0", "scale-90");
  setTimeout(() => {
    toast.classList.add("hidden");
  }, 300);
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("closeToast").addEventListener("click", hideToastSlow);
  document.getElementById("closeLogViewer").addEventListener("click", function() {
    document.getElementById("logViewer").classList.add("hidden");
  });
});
</script>

</body>
</html>
