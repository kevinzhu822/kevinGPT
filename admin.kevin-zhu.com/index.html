<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon-dark.ico" type="image/x-icon">
  <title>KevinGPT Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

<div class="max-w-4xl mx-auto mt-10 p-6" x-data="appData()" x-init="init()">
  <h1 class="text-3xl font-bold text-center mb-8">KevinGPT Admin Panel</h1>

  <!-- Panels -->
  <template x-for="panel in panels" :key="panel.title">
    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold" x-text="panel.title"></h2>
        <button x-show="panel.action" @click="panel.action()" class="text-blue-600 hover:underline text-sm">Refresh</button>
      </div>
      <div :id="panel.id" class="font-medium">Loading...</div>
      <div x-show="panel.subId" :id="panel.subId" class="text-xs text-gray-500 mt-1"></div>
    </div>
  </template>

  <!-- Cost Breakdown -->
  <div class="bg-white p-6 rounded-xl shadow-md mb-6">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-xl font-semibold">Cost Breakdown</h2>
      <span class="text-sm font-medium" :class="isLoggedIn ? 'text-green-600' : 'text-red-600'" x-text="isLoggedIn ? 'Logged In âœ“' : 'Login Required'"></span>
    </div>

    <template x-if="isLoggedIn">
      <div id="costBreakdown" class="space-y-6">
        <template x-for="vendor in vendors" :key="vendor.name">
          <div class="grid grid-cols-2 gap-4 items-start w-full">
            <span class="font-medium" x-text="vendor.displayName"></span>
            <div :id="vendor.domId" class="text-gray-600 w-full">Loading...</div>
          </div>
        </template>
      </div>
    </template>

    <template x-if="!isLoggedIn">
      <button @click="login()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Log In with Cognito</button>
    </template>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 hidden">
  <div id="toastBox" class="relative bg-white w-96 p-6 rounded-lg shadow-2xl text-center transform scale-90 opacity-0 transition-all duration-500">
    <button id="closeToast" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none">&times;</button>
    <div id="toastIcon" class="text-4xl mb-2"></div>
    <h2 id="toastMessage" class="text-lg font-medium text-gray-800"></h2>
  </div>
</div>

<script>
function appData() {
  return {
    isLoggedIn: !!localStorage.getItem('id_token'),
    vendors: [
      { name: 'openai', displayName: 'OpenAI', api: 'openai-cost', domId: 'openaiCostBreakdown' },
      { name: 'aws', displayName: 'AWS', api: 'aws-cost', domId: 'awsCostBreakdown' },
      { name: 'brave', displayName: 'Brave (Internet Search)', api: 'brave-cost', domId: 'braveCostBreakdown' },
    ],
    panels: [
      { title: 'App Status', id: 'appStatus', subId: 'appLastChecked', action: getStatus },
      { title: 'EC2 State', id: 'ec2State', subId: 'lastChecked', action: getEC2State },
    ],
    async init() {
      if (this.isLoggedIn) {
        await this.fetchCosts();
      }
    },
    async fetchCosts() {
      await Promise.all(this.vendors.map(async (vendor) => {
        const data = await fetchVendorData(vendor.api);
        if (!data) return;
        renderVendorCost(data, vendor.domId, vendor.name);
      }));
    },
    login() {
      const domain = "login.kevin-zhu.com";
      const clientId = "1epb6123uv6n1mq9q5t8sias9u";
      const redirectUri = window.location.hostname.includes("s3-website")
        ? `http://${window.location.hostname}`
        : "https://admin.kevin-zhu.com";
      window.location.href = `https://${domain}/login?client_id=${clientId}&response_type=token&scope=email+openid&redirect_uri=${redirectUri}`;
    }
  }
}

function truncateToCents(num) {
  return Math.floor(num * 100) / 100;
}

const API_BASE_URL = "https://miw5dbkttmuhs4wzs5hvbkoygq0jozll.lambda-url.us-east-2.on.aws";
const idToken = localStorage.getItem('id_token');

function login() {
  const domain = "login.kevin-zhu.com";
  const clientId = "1epb6123uv6n1mq9q5t8sias9u";
  const redirectUri = window.location.hostname.includes("s3-website")
    ? `http://${window.location.hostname}`
    : "https://admin.kevin-zhu.com";
  window.location.href = `https://${domain}/login?client_id=${clientId}&response_type=token&scope=email+openid&redirect_uri=${redirectUri}`;
}

async function fetchVendorData(api) {
  try {
    const res = await fetch(`${API_BASE_URL}?op=${api}`, { headers: { Authorization: idToken } });
    if (!res.ok) throw new Error('Fetch error');
    return res.json();
  } catch (err) {
    console.error(`Failed fetching ${api}:`, err);
    return null;
  }
}

function renderVendorCost(data, domId, vendorName) {
  const div = document.getElementById(domId);
  div.innerHTML = '';

  if (vendorName === 'aws' || vendorName === 'openai') {
    const total = vendorName === 'aws'
      ? data.services.reduce((sum, s) => sum + parseFloat(s.cost || 0), 0)
      : data.totalOpenAICost;

    const totalDiv = createTotalDiv(total);
    div.appendChild(totalDiv);

    const items = vendorName === 'aws'
      ? data.services.map(s => ({ name: s.service, cost: parseFloat(s.cost) }))
      : Object.entries(data.lineItems).map(([name, cost]) => ({ name, cost: parseFloat(cost) }));

    items.filter(i => i.cost >= 0.01)
         .sort((a, b) => b.cost - a.cost)
         .forEach(item => div.appendChild(createCostItem(item.name, item.cost)));
  } else {
    div.textContent = 'Vendor cost not implemented.';
  }
}

function createTotalDiv(total) {
  const div = document.createElement('div');
  div.className = "grid grid-cols-2 gap-4 font-semibold border-b-2 border-gray-300 pb-2 mb-2 text-base w-full";
  div.innerHTML = `
    <span class="break-words">Total</span>
    <span class="text-right">$${truncateToCents(total).toFixed(2)}</span>
  `;
  return div;
}

function createCostItem(name, cost) {
  const div = document.createElement('div');
  div.className = "grid grid-cols-2 gap-4 text-sm border-b border-gray-200 py-2 w-full";
  div.innerHTML = `
    <span class="break-words">${name}</span>
    <span class="text-right">$${truncateToCents(cost).toFixed(2)}</span>
  `;
  return div;
}

async function getStatus() {
  const url = "https://openwebui.kevin-zhu.com/health";
  try {
    const res = await fetch(url);
    const appStatus = document.getElementById("appStatus");
    const appLastChecked = document.getElementById("appLastChecked");
    appStatus.innerHTML = res.ok ? 'KevinGPT is <span class="text-green-600">online!</span>' : 'KevinGPT is <span class="text-red-600">offline</span>';
    appLastChecked.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
  } catch (err) {
    console.error('Health check failed', err);
  }
}

async function getEC2State() {
  try {
    const res = await fetch(`${API_BASE_URL}?op=status`, { headers: { Authorization: idToken } });
    const data = await res.json();
    const state = data.state?.toLowerCase() || 'unknown';
    const ec2State = document.getElementById("ec2State");
    const lastChecked = document.getElementById("lastChecked");
    ec2State.textContent = `EC2 is ${state}`;
    lastChecked.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
  } catch (err) {
    console.error('EC2 status check failed', err);
  }
}

</script>

</body>
</html>